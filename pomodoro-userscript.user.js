// ==UserScript==
// @name        pomodoro-userscript
// @version     0.0.1
// @author      crashmax <userscript@crashmax.ru>
// @license     MIT
// @homepage    https://crashmax-dev.github.io/pomodoro-userscript/
// @match       http://localhost:3000
// @match       https://example.com
// @grant       GM_addStyle
// @updateURL   https://crashmax-dev.github.io/pomodoro-userscript/pomodoro-userscript.meta.js
// @downloadURL https://crashmax-dev.github.io/pomodoro-userscript/pomodoro-userscript.user.js
// ==/UserScript==

var P=Object.defineProperty,j=(g,b,L)=>b in g?P(g,b,{enumerable:!0,configurable:!0,writable:!0,value:L}):g[b]=L,l=(g,b,L)=>(j(g,typeof b!="symbol"?b+"":b,L),L);(function(){"use strict";function g(h,t,...n){const e=document.createElement(h);return typeof t=="string"?e.append(b(t)):Array.isArray(t)?e.append(...t):(Object.assign(e,t),Object.assign(e.style,t?.style)),n.length&&e.append(...n),e}function b(h){return document.createTextNode(h)}var L=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function k(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var I={exports:{}};(function(h,t){(function(n,e){h.exports=e()})(L,function(){return function(n){function e(d){if(o[d])return o[d].exports;var m=o[d]={exports:{},id:d,loaded:!1};return n[d].call(m.exports,m,m.exports,e),m.loaded=!0,m.exports}var o={};return e.m=n,e.c=o,e.p="",e(0)}([function(n,e,o){function d(a){return a&&a.__esModule?a:{default:a}}var m=o(1),y=d(m);n.exports=y.default},function(n,e,o){function d(i,s){if(!(i instanceof s))throw new TypeError("Cannot call a class as a function")}function m(){var i=this,s=this.el,c=this.opts||r,f={};if(s.style.position="absolute",this.handle=c.handle||s,c.constrain){for(var v=c.relativeTo||s.parentNode,p=s,x=0,E=0;p!==v;)p=p.parentNode,(0,y.isRelative)(p)&&(x-=p.offsetLeft,E-=p.offsetTop),p===v&&(x+=p.offsetLeft,E+=p.offsetTop);var _=x+v.offsetWidth-s.offsetWidth,A=E+v.offsetHeight-s.offsetHeight;f.xClamp=(0,y.generateClamp)(x,_),f.yClamp=(0,y.generateClamp)(E,A)}this.opts=c,this.data=f,this.events={mousedown:a.mousedown.bind(this),mouseup:a.mouseup.bind(this),touchstart:a.touchstart.bind(this),touchstop:a.touchstop.bind(this),scrollFix:function(O){i.isDragging&&O.preventDefault()}},this.handleMove=w(this.opts.customMove),this.handle.addEventListener("mousedown",this.events.mousedown,!1),this.handle.addEventListener("touchstart",this.events.touchstart,!1),document.addEventListener("touchmove",this.events.scrollFix,{passive:!1})}Object.defineProperty(e,"__esModule",{value:!0});var y=o(2),a=o(3),w=(0,y.generateMoveFn)(),r={constrain:!1,relativeTo:null,handle:null,ignoreFn:null,highlightInputs:!1,onMouseDown:null,onMouseMove:null,onMouseUp:null,onTouchStart:null,onTouchMove:null,onTouchStop:null,customMove:null},u=function(){function i(s,c){if(d(this,i),!s)throw Error("Must include moveable element");this.el=s,this.opts=c,m.call(this)}return i.prototype.reinit=function(){this.destroy(),m.call(this)},i.prototype.destroy=function(){var s=this.events;this.handle.removeEventListener("mousedown",s.mousedown,!1),document.removeEventListener("mousemove",s.mousemove,!1),document.removeEventListener("mouseup",s.mouseup,!1),this.handle.removeEventListener("touchstart",s.touchstart,!1),document.removeEventListener("touchmove",s.touchmove,!1),document.removeEventListener("touchstop",s.touchstop,!1),document.removeEventListener("touchmove",this.events.scrollFix,{passive:!1})},i}();e.default=function(i,s){return new u(i,s)}},function(n,e){function o(a,w){return function(r){return Math.min(Math.max(r,a),w)}}function d(a){return window.getComputedStyle(a).position==="relative"}function m(){return window.requestAnimationFrame?function(a){var w=a||y;return function(r,u,i){window.requestAnimationFrame(function(){w(r,u,i)})}}:function(a){return function(w,r,u){var i=a||y;i(w,r,u)}}}function y(a,w,r){a.style.left=w+"px",a.style.top=r+"px"}Object.defineProperty(e,"__esModule",{value:!0}),e.generateClamp=o,e.isRelative=d,e.generateMoveFn=m},function(n,e){function o(r){var u=this.opts;if(u.highlightInputs){var i=r.target.tagName.toLowerCase();if(i==="input"||i==="textarea")return}if(!u.ignoreFn||!u.ignoreFn(r)){if(r.button===0){var s=this.el,c=this.events;typeof u.onMouseDown=="function"&&u.onMouseDown(s,r);var f=r.clientX-s.offsetLeft,v=r.clientY-s.offsetTop;c.mousemove=d.bind(this,f,v),document.addEventListener("mousemove",c.mousemove,!1),document.addEventListener("mouseup",c.mouseup,!1)}r.preventDefault()}}function d(r,u,i){var s=this.el,c=this.opts,f=this.data;typeof c.onMouseMove=="function"&&c.onMouseMove(s,i);var v=i.clientX-r,p=i.clientY-u;return c.constrain&&(v=f.xClamp(v),p=f.yClamp(p)),this.handleMove(s,v,p),i.preventDefault(),!1}function m(r){var u=this.el,i=this.opts,s=this.events;typeof i.onMouseUp=="function"&&i.onMouseUp(u,r),document.removeEventListener("mouseup",s.mouseup,!1),document.removeEventListener("mousemove",s.mousemove,!1)}function y(r){var u=this.opts;if(u.highlightInputs){var i=r.target.tagName.toLowerCase();if(i==="input"||i==="textarea")return}if(!u.ignoreFn||!u.ignoreFn(r)){var s=this.el,c=this.events;typeof u.onTouchStart=="function"&&u.onTouchStart(s,r);var f=r.targetTouches[0],v=f.clientX-s.offsetLeft,p=f.clientY-s.offsetTop;c.touchmove=a.bind(this,v,p),this.isDragging=!0,document.addEventListener("touchmove",c.touchmove,!1),document.addEventListener("touchend",c.touchstop,!1),document.addEventListener("touchcancel",c.touchstop,!1)}}function a(r,u,i){var s=this.el,c=this.opts,f=this.data;typeof c.onTouchMove=="function"&&c.onTouchMove(s,i);var v=i.targetTouches[0],p=v.clientX-r,x=v.clientY-u;return c.constrain&&(p=f.xClamp(p),x=f.yClamp(x)),this.handleMove(s,p,x),i.preventDefault(),!1}function w(r){this.isDragging=!1;var u=this.el,i=this.opts,s=this.events;typeof i.onTouchStop=="function"&&i.onTouchStop(u,r),document.removeEventListener("touchmove",s.touchmove,!1),document.removeEventListener("touchend",s.touchstop,!1),document.removeEventListener("touchcancel",s.touchstop,!1)}Object.defineProperty(e,"__esModule",{value:!0}),e.mousedown=o,e.mousemove=d,e.mouseup=m,e.touchstart=y,e.touchmove=a,e.touchstop=w}])})})(I);const T=k(I.exports);class S{constructor(...t){l(this,"target"),l(this,"displace"),l(this,"options");var n;this.target=((n=this.options)==null?void 0:n.handle)??t[0],this.options=t[1],this.displace=T(...t),this.destroy(),this.reinit=this.reinit.bind(this);const e=()=>{this.displace.reinit(),this.target.removeEventListener("mouseenter",e)};this.target.addEventListener("mouseenter",e),window.addEventListener("resize",this.reinit)}reinit(){this.displace.reinit()}destroy(){this.displace.destroy(),window.removeEventListener("resize",this.reinit)}changePosition(t,n){this.target.style.left=`${t}px`,this.target.style.top=`${n}px`}}class D{constructor(t,n,e,o){l(this,"serialize"),l(this,"deserialize"),this.key=t,this.initialValue=n,this.storage=e,this.serialize=d=>o!=null&&o.serialize?o.serialize(d):JSON.stringify(d),this.deserialize=d=>o!=null&&o.deserialize?o.deserialize(d):JSON.parse(d)}get values(){try{const t=this.storage.getItem(this.key);return t?this.deserialize(t):this.initialValue}catch{return this.initialValue}}write(t){t instanceof Function&&(t=t(this.values));try{this.storage.setItem(this.key,this.serialize(t))}catch(n){return console.error(`Failed to save (${this.key}):`,n.message),this.initialValue}return t}reset(){this.write(this.initialValue)}}class C extends D{constructor(t,n,e){super(t,n,localStorage,e)}}class V{constructor(){l(this,"el"),l(this,"interact"),l(this,"store",new C("position",{x:0,y:0}))}mount(t){this.el=g("div",{className:"overlay"},t),this.interact=new S(t,{constrain:!0,relativeTo:this.el,handle:t,onMouseDown:()=>{this.el.classList.add("grabbing")},onMouseUp:()=>{this.el.classList.remove("grabbing")},onMouseMove:n=>{const{x:e,y:o}=n.getBoundingClientRect();this.store.write({x:e,y:o})}}),this.updatePosition(),document.body.appendChild(this.el)}updatePosition(){const{x:t,y:n}=this.store.values;this.interact.changePosition(t,n)}}function M(h){return h<10?`0${h}`:`${h}`}class F{constructor(){l(this,"el"),l(this,"seconds"),l(this,"minutes"),l(this,"inputClock",0),l(this,"currentInput"),l(this,"store",new C("timer",{minutes:0,seconds:0}))}get currentState(){return{type:this.currentInput.dataset.type,textContent:this.currentInput.textContent}}mount(){const t=["minutes","seconds"];for(const n of t){const e=g("div",{contentEditable:"true"});e.dataset.type=n,e.addEventListener("keydown",o=>this.onKeyDown(o)),e.addEventListener("click",o=>{o.preventDefault(),this.focusInput(e)}),this[n]=e}this.updateInputValues(),this.el=g("div",{className:"timer"},this.minutes,":",this.seconds)}focusInput(t){this.currentInput=t,this.currentInput.focus(),this.updateInputClock(0)}onKeyDown(t){switch(t.preventDefault(),t.key){case"Enter":case"Escape":return this.currentInput.blur();case"ArrowLeft":case"ArrowRight":return this.navigateInput();case"ArrowUp":case"ArrowDown":return this.incrementInputValue(t.key==="ArrowUp"?1:-1)}Number.isNaN(parseInt(t.key))||this.changeInputValue(t.key)}navigateInput(){const t=this.currentInput.nextElementSibling??this.currentInput.previousElementSibling;this.focusInput(t)}changeInputValue(t){const{type:n,textContent:e}=this.currentState,o=parseInt(this.inputClock?e.slice(1)+t:e.slice(0,1)+t);switch(n){case"minutes":this.changeMinutesValue(o);break;case"seconds":this.changeSecondsValue(o);break}this.updateInputClock()}incrementInputValue(t){const{type:n,textContent:e}=this.currentState,o=parseInt(e);switch(n){case"minutes":return this.changeMinutesValue(o+t);case"seconds":return this.changeSecondsValue(o+t)}}changeMinutesValue(t){t<0&&(t=99),t>99&&(t=0),this.minutes.textContent=M(t),this.store.write(n=>({...n,minutes:t}))}changeSecondsValue(t){t<0&&(t=59),t>59&&(t=0),this.seconds.textContent=M(t),this.store.write(n=>({...n,seconds:t}))}updateInputClock(t){this.inputClock=t??(this.inputClock+1)%2}updateInputValues(){const{minutes:t,seconds:n}=this.store.values;this.minutes.textContent=M(t),this.seconds.textContent=M(n)}}class N{constructor(){l(this,"el"),l(this,"container"),l(this,"draggable"),l(this,"timer")}mount(t,n){this.timer=n,this.draggable=t,this.container=g("div",{className:"widget-container"},this.timer.el),this.el=g("div",{className:"widget",onmouseenter:()=>{this.draggable.el.classList.add("moved")},onmouseleave:()=>{this.draggable.el.classList.remove("moved")},onauxclick:e=>{e.preventDefault()},oncontextmenu:e=>{e.preventDefault()}},this.container)}}const U="";class z{constructor(){l(this,"timer",new F),l(this,"draggable",new V),l(this,"widget",new N)}mount(){this.timer.mount(),this.widget.mount(this.draggable,this.timer),this.draggable.mount(this.widget.el),window.addEventListener("storage",t=>{switch(t.key){case"position":return this.draggable.updatePosition();case"timer":return this.timer.updateInputValues()}})}}new z().mount(),GM_addStyle(".overlay{left:0;top:0;width:100%;height:100%;cursor:grab}.overlay.moved{position:fixed}.overlay.grabbing{cursor:grabbing}.overlay .widget{z-index:999999;position:fixed!important;background-color:#1f1f23;width:70px;height:32px;box-shadow:0 6px 16px #00000080,0 0 4px #0006;border:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;align-items:center;justify-content:center}.overlay .widget-container{font-family:Trebuchet MS,Lucida Sans Unicode,Lucida Grande,Lucida Sans,Arial,sans-serif;font-size:24px;color:#fff}.timer{display:flex;flex-direction:row}.timer div{display:block;text-align:center;caret-color:transparent}.timer div:focus{outline:none;color:tomato}")})();
